# .github/workflows/deploy-production.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  notify-deployment:
    name: Production Deployment Notification
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify deployment start
        run: |
          echo "ğŸš€ Deployment to AWS Amplify triggered"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: main"
          echo "ğŸ“ Commit: ${{ steps.commit.outputs.sha_short }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ’¬ Message: ${{ steps.commit.outputs.message }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â³ AWS Amplify will automatically deploy this commit"
          echo "ğŸ”— Monitor at: https://console.aws.amazon.com/amplify"
          echo ""
          echo "â±ï¸  Typical deployment time: 3-7 minutes"

  # Optional: Post-deployment verification
  # Runs 5 minutes after deployment starts (more realistic timing)
  post-deploy-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: notify-deployment
    # Make this job optional - won't fail the workflow
    continue-on-error: true

    steps:
      - name: Wait for Amplify deployment
        run: |
          echo "â³ Waiting 5 minutes for Amplify to build and deploy..."
          echo "Start time: $(date)"
          sleep 300  # 5 minutes
          echo "Check time: $(date)"

      - name: Basic health check
        id: health
        run: |
          echo "ğŸ” Checking site health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://kuroshio-lab.com)
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          if [ $RESPONSE -eq 200 ]; then
            echo "âœ… Site is responding (HTTP $RESPONSE)"
          else
            echo "âš ï¸  Site returned HTTP $RESPONSE (might still be deploying)"
          fi

      - name: Check response time
        run: |
          echo "âš¡ Checking response time..."
          TIME=$(curl -o /dev/null -s -w '%{time_total}\n' https://kuroshio-lab.com)
          echo "Response time: ${TIME}s"

          # Convert to milliseconds for comparison
          TIME_MS=$(echo "$TIME * 1000" | bc)

          if (( $(echo "$TIME_MS < 2000" | bc -l) )); then
            echo "âœ… Response time is good (< 2s)"
          else
            echo "âš ï¸  Response time is slow (> 2s)"
          fi

      - name: Deployment status summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Status Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Site URL: https://kuroshio-lab.com"
          echo "ğŸ“ˆ Health Status: HTTP ${{ steps.health.outputs.response }}"
          echo "âš ï¸  Note: This check may run before deployment completes"
          echo "ğŸ”— Verify in Amplify Console for actual deployment status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
